---
import "../styles/custom.css";
import SEO from "../components/SEO.astro";
import { t } from "../lib/i18n";

// שפה קבועה: עברית
const lang = 'he';

const {
  title = t(lang, "siteName") || "עולם המצפן",
  description = t(lang, "siteDescription") || "יקום רעיונות חי של גיא ברכה",
  image = "/legacy/gallery/compass-alliance-artwork.webp"
} = Astro.props;

// BASE
const RAW_BASE = import.meta.env.BASE_URL ?? "/";
const BASE = RAW_BASE.endsWith("/") ? RAW_BASE : `${RAW_BASE}/`;
const withBase = (p = "") => {
  if (!p) return BASE;
  if (/^(https?:)?\/\//i.test(p) || /^mailto:|^tel:/i.test(p)) return p;
  const clean = p.replace(/^\/+/, "");
  return `${BASE}${clean}`;
};
---
<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <SEO
      title={title}
      description={description}
      image={image}
      siteName={t(lang, "siteName") || "עולם המצפן"}
      locale="he_IL"
      twitter={{ card: "summary_large_image", site: "@GuyBracha" }}
    />

    <slot name="head" />
    <link rel="icon" type="image/png" href={withBase("/legacy/prime-children-hero.png")} />

    <!-- Fonts: Heebo לטקסט, Secular One לכותרות -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;800&family=Secular+One&display=swap" rel="stylesheet" />

    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" crossorigin="anonymous" />

    <style>
      :root {
        --brand: #ffb703;
        --font-sans: "Heebo", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
        --font-display-he: "Secular One", "Heebo", sans-serif;
      }
      body {
        font-family: var(--font-sans);
        background: #0b0b0b; color: #e5e7eb;
        direction: rtl; text-align: right;
      }
      a { text-decoration: none; }
      .brand { color: var(--brand); }
      .card { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.12); }
      .img-cover { object-fit: cover; width: 100%; height: 200px; border-radius: 0.75rem; }
      .will-animate { will-change: transform, opacity; }
      .navbar-toggler { border-color: rgba(255,255,255,.3); }

      /* Brand anim */
      .navbar-brand.brand-anim { display: inline-block; line-height: 1; animation: cw-pop .6s ease-out both; }
      .cw-word{ position: relative; display: inline-block; background: linear-gradient(90deg,#ffffff,var(--brand),#00d4ff 60%,#a855f7); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; animation: cw-shine 6s linear infinite; letter-spacing: .2px; }
      .cw-accent{ filter: drop-shadow(0 0 10px rgba(255,183,3,.25)); animation-delay: .6s; }
      .navbar-brand.brand-anim:hover .cw-word{ animation-duration: 2.4s; transform: translateY(-1px); transition: transform .2s ease; }
      @keyframes cw-shine{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
      @keyframes cw-pop{ 0%{opacity:0;transform:translateY(-6px) scale(.98)} 100%{opacity:1;transform:none} }

      /* LTR חריגים */
      pre, code, kbd, samp, .ltr-block { direction: ltr; unicode-bidi: bidi-override; text-align: left; }

      /* כותרות בעברית – פונט תצוגה */
      .font-display-he { font-family: var(--font-display-he); font-weight: 900; letter-spacing: .02em; }
    </style>

    {import.meta.env.MODE === "production" && (
      <>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-XQXW42MC8Z"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XQXW42MC8Z');
        </script>
      </>
    )}
  </head>
  <body>
    <header class="border-bottom border-secondary-subtle">
      <nav class="navbar navbar-expand-lg navbar-dark" style="background: transparent;">
        <div class="container">
          <!-- Brand -->
          <a href={withBase("/")} class="navbar-brand fw-bold brand-anim" aria-label="עולם המצפן">
            <span class="cw-word">עולם</span>
            <span class="cw-word cw-accent">המצפן</span>
          </a>

          <!-- Toggler -->
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNav"
            aria-controls="mainNav"
            aria-expanded="false"
            aria-label="פתיחת תפריט"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <!-- Collapse -->
          <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav ms-auto gap-lg-2">
              <li class="nav-item"><a class="nav-link" href={withBase("/comics/")}>קומיקס</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/characters/")}>דמויות</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/history/")}>ציר זמן</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/atlas/")}>אטלס</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/prime-children/")}>ילדי פריים</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/villains/")}>נבלים</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/ideas/")}>רעיונות</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/gallery/")}>גלריה</a></li>
              <li class="nav-item"><a class="nav-link text-white-50" href={withBase("/about/")}>אודות</a></li>
              <!-- אין מתג שפה -->
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main class="py-4">
      <slot />
    </main>

    <footer class="py-5 border-top border-secondary-subtle">
      <div class="container d-flex justify-content-between flex-wrap gap-3">
        <a href="https://guybracha.github.io/compass-world/" class="btn btn-outline-light btn-sm">האתר הישן</a>
        <small class="text-white-50">© {new Date().getFullYear()} Guy Bracha</small>
        <a href="mailto:guy.bracha@gmail.com" class="btn btn-outline-light btn-sm">אימייל</a>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/ScrollTrigger.min.js" defer></script>
    <script src={withBase("/scripts/gsap-init.js")} defer></script>

    <!-- פלייבק אם Bootstrap לא נטען -->
    <script defer>
      window.addEventListener('DOMContentLoaded', () => {
        try {
          if (window.bootstrap) return;
          console.warn('Bootstrap NOT detected – enabling minimal navbar fallback');
          const toggler = document.querySelector('.navbar-toggler');
          const menu = document.getElementById('mainNav');
          if (toggler && menu) toggler.addEventListener('click', () => menu.classList.toggle('show'));
        } catch (e) { console.warn('Navbar fallback failed:', e); }
      });
    </script>
  </body>
</html>

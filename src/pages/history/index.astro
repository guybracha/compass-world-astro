---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const list = await getCollection('history');

// ✅ תמיכה בתת-נתיב (GitHub Pages)
const BASE = import.meta.env.BASE_URL || "/";
const withBase = (p = "") =>
  p && !/^https?:\/\//i.test(p)
    ? `${BASE}${String(p).replace(/^\/+/, "")}` // מונע //
    : p || "";

// ממיר "750BC", "200 CE", "c. 150 bc", "700–600 BC" וכו' למספר; BC שלילי
function yearKey(y: unknown) {
  if (typeof y === 'number') return y;
  const s = String(y ?? '').trim().toLowerCase();
  if (!s) return Number.POSITIVE_INFINITY;
  const isBC = /\b(?:bc|bce)\b/.test(s);
  const m = s.match(/-?\d{1,4}/);
  if (!m) return Number.POSITIVE_INFINITY;
  const n = parseInt(m[0], 10);
  return isBC ? -n : n;
}

const sorted = [...list].sort((a, b) => {
  const ka = yearKey(a.data.year);
  const kb = yearKey(b.data.year);
  if (ka !== kb) return ka - kb;
  return a.slug.localeCompare(b.slug);
});

const PLACEHOLDER = withBase('/assets/placeholders/history.webp');
---

<BaseLayout title="Chronology | Compass World">
  <section class="container py-4">
    <h1 class="h3 mb-4">Chronology</h1>
    <div class="row g-4">
      {sorted.map((h) => {
        const href = withBase(`history/${h.slug}/`);
        const imgSrc = withBase(h.data.image || '');
        return (
          <div class="col-12 col-md-6 col-lg-4">
            <a class="card p-3 h-100 d-block will-animate" href={href}>
              <h2 class="h5 text-white mb-1">{h.data.year}</h2>
              {h.data.image && (
                <img
                  src={imgSrc}
                  alt={h.data.year}
                  class="img-cover mt-2"
                  loading="lazy"
                  onerror={`this.onerror=null;this.src='${PLACEHOLDER}';`}
                />
              )}
              <p class="text-white-50 mt-2 mb-0">{h.data.description}</p>
            </a>
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>

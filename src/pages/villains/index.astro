---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const all = await getCollection('villains');
const orgs    = all.filter(e => e.data.kind === 'org');
const leaders = all.filter(e => e.data.kind === 'leader');

// ✅ תמיכה בתת-נתיב (GitHub Pages וכד')
const BASE = import.meta.env.BASE_URL || "/";
const withBase = (p = "") =>
  p && !/^https?:\/\//i.test(p)
    ? `${BASE}${String(p).replace(/^\/+/, "")}`
    : p || "";
---
<BaseLayout title="נבלים | עולם המצפן" description="ארגונים ומנהיגים">
  <section class="container py-5">
    <h1 class="h3 mb-4">נבלים</h1>

    <h2 class="h5 mb-3">ארגונים</h2>
    <div class="row g-4 mb-5">
      {orgs.map(({ slug, data }) => {
        const href = withBase(`/villains/${slug}/`);
        const img  = data.image ? withBase(data.image) : null;
        return (
          <div class="col-md-6" data-reveal>
            <a class="card p-3 d-block" href={href} data-tilt>
              {img && <img src={img} alt={data.title} class="img-cover mb-3 parallax" />}
              <h3 class="h5 m-0">{data.title}</h3>
              {Array.isArray(data.leaders) && data.leaders.length>0 && (
                <div class="small text-white-50 mt-1">מנהיגים: {data.leaders.join(', ')}</div>
              )}
            </a>
          </div>
        );
      })}
    </div>

    <h2 class="h5 mb-3">מנהיגים</h2>
    <div class="row g-4">
      {leaders.map(({ slug, data }) => {
        const href = withBase(`/villains/${slug}/`);
        const img  = data.image ? withBase(data.image) : null;
        return (
          <div class="col-sm-6 col-lg-4" data-reveal>
            <a class="card p-3 d-block" href={href} data-tilt>
              {img && <img src={img} alt={data.title} class="img-cover mb-3 parallax" />}
              <h3 class="h6 m-0">{data.title}</h3>
              {data.org && <div class="small text-white-50 mt-1">{data.org}</div>}
            </a>
          </div>
        );
      })}
    </div>
  </section>
</BaseLayout>

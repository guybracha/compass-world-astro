---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export const prerender = true; // סטטי, מתאים ל-GitHub Pages

// לבנות את כל דפי הדמויות מ-src/content/characters
export async function getStaticPaths() {
  const entries = await getCollection('characters');
  return entries.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error('Missing slug');

const entry = await getEntryBySlug('characters', slug);
if (!entry) throw new Error(`Character not found: ${slug}`);

const { Content, data } = await entry.render();

// כותרת/תיאור בעברית
const pageTitle = `${data?.name ?? entry.slug} | עולם המצפן`;
const pageDesc  = data?.summary ?? `דף פרופיל עבור ${data?.name ?? entry.slug}.`;

// תמיכה ב־BASE_URL (למשל /compass-world-astro/)
const BASE = import.meta.env.BASE_URL || '/';
const withBase = (p = '') =>
  p.startsWith('http')
    ? p
    : `${BASE.replace(/\/$/, '')}${p.startsWith('/') ? p : `/${p}`}`;
---
<BaseLayout title={pageTitle} description={pageDesc}>
  <section class="container py-4" data-reveal>
    <a href={withBase('/characters/')} class="text-white-50 text-decoration-none">
      <i class="bi bi-arrow-right-short"></i> חזרה לדמויות
    </a>

    <div class="row mt-3 g-4">
      <div class="col-lg-4">
        {data?.image && (
          <img
            src={withBase(data.image)}
            alt={data.name}
            class="img-fluid rounded-3 shadow-sm will-animate"
            loading="lazy"
            decoding="async"
          />
        )}
        {Array.isArray(data?.tags) && data.tags.length > 0 && (
          <div class="mt-3 d-flex flex-wrap gap-2">
            {data.tags.map((t) => (
              <span class="badge bg-secondary-subtle text-secondary-emphasis">{t}</span>
            ))}
          </div>
        )}
      </div>

      <div class="col-lg-8">
        <h1 class="h3 font-display-he">{data?.name ?? entry.slug}</h1>
        {data?.team && <p class="text-white-50 mb-1">צוות: {data.team}</p>}
        {data?.role && <p class="text-white-50 mb-3">תפקיד: {data.role}</p>}
        <article class="prose text-white-80">
          <Content />
        </article>
      </div>
    </div>
  </section>

  <style>
    /* תמונות */
    .prose img { max-width: 100%; height: auto; }
  </style>
</BaseLayout>

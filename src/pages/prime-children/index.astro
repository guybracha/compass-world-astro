---
// src/pages/prime-children/index.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export const prerender = true;

/* ---------- base helpers (GitHub Pages subpath safe) ---------- */
const RAW_BASE = import.meta.env.BASE_URL ?? "/";
const BASE = RAW_BASE.endsWith("/") ? RAW_BASE : `${RAW_BASE}/`;
const withBase = (p = "") => {
  if (!p) return BASE;
  if (/^(https?:)?\/\//i.test(p) || /^mailto:|^tel:/i.test(p)) return p;
  const clean = String(p).replace(/^\/+/, "");
  return `${BASE}${clean}`;
};

/* ---------- data ---------- */
const all = await getCollection('prime-children');

const overviewEntry = all.find((e) => (e.data.kind ?? 'member') === 'overview');
let OverviewContent = null;
let odata: any = null;
if (overviewEntry) {
  const rendered = await overviewEntry.render();
  OverviewContent = rendered.Content;
  odata = rendered.data;
}

const members = all
  .filter((e) => (e.data.kind ?? 'member') !== 'overview')
  .sort((a, b) => a.slug.localeCompare(b.slug));

/** עיבוד נתונים לסינון/תיוג */
const RAW_PLACEHOLDER = 'images/avatar-placeholder.svg';
const PLACEHOLDER = withBase(RAW_PLACEHOLDER);
const SIDE_WORDS = new Set(['hero', 'villain', 'גיבור', 'נבל']);

function getSide(d: any): string {
  if (d.side) return String(d.side);
  if (Array.isArray(d.tags)) {
    const lower = d.tags.map((t: string) => String(t).toLowerCase());
    if (lower.includes('hero') || lower.includes('גיבור')) return 'גיבור';
    if (lower.includes('villain') || lower.includes('נבל')) return 'נבל';
  }
  return '';
}

const powers = Array.from(new Set(
  members.map((m) => m.data.power).filter(Boolean) as string[]
)).sort((a, b) => a.localeCompare(b, 'he'));

const sides = Array.from(new Set(
  members.map((m) => getSide(m.data)).filter(Boolean)
)).sort((a, b) => a.localeCompare(b, 'he'));

const categories = Array.from(new Set(
  members
    .flatMap((m) => (Array.isArray(m.data.tags) ? m.data.tags : []))
    .filter(Boolean)
    .filter((t) => !SIDE_WORDS.has(String(t).toLowerCase()))
)).sort((a, b) => String(a).localeCompare(String(b), 'he'));
---

<BaseLayout title="ילדי פריים | עולם המצפן" description="סקירה, סינון ורשימת חברים">
  <section class="container py-5">
    <!-- כותרת -->
    <header class="text-center mb-4" data-reveal>
      <h1 class="display-6 fw-extrabold text-warning title-glow">ילדי פריים</h1>
      <p class="lead text-white-50 m-0">דור של כוחות — עולם משתנה.</p>
    </header>

    <!-- בלוק סקירה מתוך ה-collection אם קיים -->
    {OverviewContent && (
      <article class="card card-glass p-4 p-md-5 mb-5" data-reveal>
        {odata?.image && (
          <figure class="mb-4">
            <img
              src={withBase(odata.image)}
              alt={odata?.title ?? 'ילדי פריים'}
              class="img-fluid rounded-4 shadow-sm parallax"
            />
          </figure>
        )}
        <OverviewContent />
      </article>
    )}

    <!-- ״מה זה ילדי פריים?״ — בלוקים בהשראת האתר הישן -->
    <section class="mb-5" aria-labelledby="what-are-prime">
      <h2 id="what-are-prime" class="h4 text-warning mb-3" data-reveal>
        מה הם ״ילדי פריים״?
      </h2>

      <div class="row g-4">
        <div class="col-12 col-lg-6" data-reveal>
          <div class="info-block">
            <h3 class="h6 text-warning mb-2"><i class="bi bi-activity me-1"></i> תכונות ליבה</h3>
            <ul class="m-0 ps-3 small text-white-70">
              <li><strong>פנוטיפ לא שגרתי:</strong> זוהר עיניים, גווני עור/דפוסים חריגים, פלומה/סימנים וסטיגיאליים.</li>
              <li><strong>תחומי כוח:</strong> יסודות, שדות ביו-חשמליים, טלֶה/פסי, עיצוב חומר, הגברה קינטית, ולעיתים נדירות מרחב/זמן.</li>
              <li><strong>עקומת יציבות:</strong> קפיצה בעוצמה תחת סטרס → התייצבות עם אימון ושליטה.</li>
              <li><strong>חתימה אנרגטית:</strong> ניתנת לזיהוי על-ידי מערכי חישה מתקדמים (למשל Interguard).</li>
            </ul>
          </div>
        </div>

        <div class="col-12 col-lg-6" data-reveal>
          <div class="info-block">
            <h3 class="h6 text-warning mb-2"><i class="bi bi-hourglass-split me-1"></i> הופעה ראשונה ולוח זמנים</h3>
            <ul class="m-0 ps-3 small text-white-70">
              <li><strong>סימנים מוקדמים:</strong> מקרים בודדים סביב 2020.</li>
              <li><strong>מודעות ציבורית:</strong> התגבשות אשכולות ודיווחי מדיה (2020–2021).</li>
              <li><strong>נקודת קונפליקט:</strong> מאי 2022 — חדירות ״המפתחים״ המכוונות לילדי פריים.</li>
              <li><strong>תגובה מוסדית:</strong> הקמת <em>Interguard</em> לפיקוח והסדרה.</li>
            </ul>
          </div>
        </div>

        <div class="col-12 col-lg-6" data-reveal>
          <div class="info-block">
            <h3 class="h6 text-warning mb-2"><i class="bi bi-lightning-charge me-1"></i> טריגרים והופעה</h3>
            <ul class="m-0 ps-3 small text-white-70">
              <li><strong>תחילת ביטוי:</strong> לרוב בגיל ההתבגרות; ״התפרצות ראשונה״ תחת עומס רגשי/סביבתי.</li>
              <li><strong>וקטורי אימון:</strong> מדיטציה, ביו-פידבק, חניכה, אימוני צוות.</li>
              <li><strong>מגבלות:</strong> עייפות כוח, כוויות פידבק, עומס חושים, וזמן התאוששות ארוך בשיא.</li>
            </ul>
          </div>
        </div>

        <div class="col-12 col-lg-6" data-reveal>
          <div class="info-block">
            <h3 class="h6 text-warning mb-2"><i class="bi bi-people me-1"></i> השפעה חברתית</h3>
            <ul class="m-0 ps-3 small text-white-70">
              <li><strong>עמדות קהל:</strong> הירואיות לצד חשש; דיונים על זכויות, זהות וחובה.</li>
              <li><strong>מוסדות:</strong> התאמות במערכות חינוך ובריאות; יחידות תגובה ייעודיות.</li>
              <li><strong>גיאופוליטיקה:</strong> מרוץ חימוש טכנולוגי לזיהוי/ריסון; גיוס ע״י מדינות ושחקנים חוץ-עולמיים.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ קומפקטי (details/summary ללא JS חיצוני) -->
    <section class="mb-5" aria-labelledby="faq-title">
      <h2 id="faq-title" class="h5 text-warning mb-3" data-reveal>
        שאלות נפוצות
      </h2>

      <div class="faq-list">
        <details class="faq-item" data-reveal>
          <summary>נולדים כך או משתנים בהמשך?</summary>
          <div class="faq-body small text-white-70">
            ברוב המקרים קיימים סמנים רדומים מלידה, והיכולת מתפרצת סביב גיל ההתבגרות או באירוע קיצון.
          </div>
        </details>

        <details class="faq-item" data-reveal>
          <summary>איך מזהים אותם?</summary>
          <div class="faq-body small text-white-70">
            שילוב של דיווחים התנהגותיים, אנומליות רפואיות וסורקים ייעודיים הקוראים חתימות ביו-אנרגטיות קוהרנטיות.
          </div>
        </details>

        <details class="faq-item" data-reveal>
          <summary>מה לגבי אתיקה של פיקוח?</summary>
          <div class="faq-body small text-white-70">
            מתקיים ויכוח מתמשך בין בטחון הציבור לזכויות אזרח — במיוחד לקטינים — כשגופי פיקוח נתונים לביקורת קהילתית.
          </div>
        </details>
      </div>
    </section>

    {/** 🔎 סרגל סינון */}
    <section id="prime-lineages" class="rounded-4 p-3 p-md-4 mb-4 border border-2 border-dark-subtle bg-black-55" aria-labelledby="filters-title">
      <h2 id="filters-title" class="visually-hidden">סינון, מיון וחיפוש</h2>
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label for="filterSide" class="form-label small text-white-50">צד</label>
          <select id="filterSide" class="form-select bg-black text-white border-secondary">
            <option value="">הכל</option>
            {sides.map((s) => <option value={s}>{s}</option>)}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label for="filterPower" class="form-label small text-white-50">כוח</label>
          <select id="filterPower" class="form-select bg-black text-white border-secondary">
            <option value="">הכל</option>
            {powers.map((p) => <option value={p}>{p}</option>)}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label for="filterCat" class="form-label small text-white-50">קטגוריה</label>
          <select id="filterCat" class="form-select bg-black text-white border-secondary">
            <option value="">הכל</option>
            {categories.map((c) => <option value={c}>{c}</option>)}
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label for="filterSearch" class="form-label small text-white-50">חיפוש</label>
          <input id="filterSearch" type="search" class="form-control bg-black text-white border-secondary" placeholder="שם, כוח או תגית…" />
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
        <div class="text-white-50 small">
          תוצאות: <strong id="pcCount">{members.length}</strong>
        </div>
        <div class="ms-auto d-flex gap-2">
          <select id="sortBy" class="form-select form-select-sm bg-black text-white border-secondary" style="width:auto" aria-label="מיון">
            <option value="name-asc">מיין: שם א→ת</option>
            <option value="name-desc">מיין: שם ת→א</option>
            <option value="power-asc">מיין: כוח א→ת</option>
            <option value="power-desc">מיין: כוח ת→א</option>
          </select>
          <button id="clearFilters" class="btn btn-outline-light btn-sm">נקה</button>
        </div>
      </div>
    </section>

    <!-- רשת הכרטיסים -->
    <div class="row g-4" id="pcGrid" aria-live="polite">
      {members.length > 0 ? (
        members.map(({ slug, data }) => {
          const name = data.name ?? data.title;
          const side = getSide(data);
          const rawImg = data.image ?? PLACEHOLDER;
          const img = withBase(rawImg);
          const tagList = Array.isArray(data.tags) ? data.tags : [];
          const indexText = [name, data.power ?? '', side, ...tagList].join(' ').toLowerCase();

          return (
            <div
              class="col-sm-6 col-lg-4"
              data-reveal
              data-card
              data-name={String(name).toLowerCase()}
              data-power={String(data.power ?? '').toLowerCase()}
              data-side={String(side).toLowerCase()}
              data-tags={String(tagList.join(' ')).toLowerCase()}
              data-index={indexText}
            >
              <a
                class="card pc-card h-100 d-block p-3 pc-glow"
                href={withBase(`prime-children/${slug}/`)}
                aria-label={`לצפייה בפרופיל של ${name}`}
                data-tilt
              >
                <div class="pc-thumb mb-3">
                  <img src={img} alt={name} class="img-cover parallax" loading="lazy" />
                </div>

                <h2 class="pc-title m-0">{name}</h2>

                <div class="mt-2 d-flex flex-wrap gap-2">
                  {side && <span class={`badge ${side === 'נבל' ? 'bg-danger' : 'bg-success'}`}>{side}</span>}
                  {data.power && <span class="badge bg-warning text-dark">{data.power}</span>}
                  {tagList.map((t) => <span class="badge bg-secondary">{t}</span>)}
                </div>
              </a>
            </div>
          );
        })
      ) : (
        <p class="text-white-50" data-reveal>
          אין עדיין דמויות של ילדי פריים. הוסף קבצים תחת <code>src/content/prime-children</code>.
        </p>
      )}
    </div>

    <!-- CTA לקבוצת הפייסבוק (בהשראת האתר הישן) -->
    
  </section>

  <!-- 🧠 סקריפט סינון/מיון/חיפוש -->
  <script is:inline>
    (() => {
      const $  = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));
      const norm = (v) => (v ?? '').toString().trim().toLowerCase();

      const selSide   = $('#filterSide');
      const selPower  = $('#filterPower');
      const selCat    = $('#filterCat');
      const inpSearch = $('#filterSearch');
      const sortSel   = $('#sortBy');
      const clearBtn  = $('#clearFilters');
      const countEl   = $('#pcCount');
      const grid      = $('#pcGrid');

      if (!grid) return;

      const cards = $$('#pcGrid [data-card]');

      function apply() {
        const side = norm(selSide?.value);
        const pow  = norm(selPower?.value);
        const cat  = norm(selCat?.value);
        const q    = norm(inpSearch?.value);

        let shown = 0;

        cards.forEach((el) => {
          const elSide = norm(el.dataset.side);
          const elPow  = norm(el.dataset.power);
          const elTags = norm(el.dataset.tags);
          const idx    = norm(el.dataset.index);

          const okSide  = !side || elSide === side;
          const okPower = !pow  || elPow  === pow;
          const okCat   = !cat  || (cat && elTags.split(' ').includes(cat));
          const okQ     = !q    || idx.includes(q);

          const show = okSide && okPower && okCat && okQ;

          el.classList.toggle('d-none', !show);
          if (show) shown++;
        });

        if (countEl) countEl.textContent = String(shown);

        // ----- מיון בין הכרטיסים הגלויים -----
        const sortBy = sortSel?.value || 'name-asc';
        const visible = cards.filter((c) => !c.classList.contains('d-none'));

        const getKey = (el, key) => norm(el.dataset[key]);

        visible.sort((a, b) => {
          switch (sortBy) {
            case 'name-asc':   return getKey(a, 'name' ).localeCompare(getKey(b, 'name' ), 'he');
            case 'name-desc':  return getKey(b, 'name' ).localeCompare(getKey(a, 'name' ), 'he');
            case 'power-asc':  return getKey(a, 'power').localeCompare(getKey(b, 'power'), 'he');
            case 'power-desc': return getKey(b, 'power').localeCompare(getKey(a, 'power'), 'he');
            default: return 0;
          }
        });

        // הזרקה מחדש לפי הסדר
        visible.forEach((el) => grid.appendChild(el));
      }

      // האזנות
      selSide?.addEventListener('change', apply);
      selPower?.addEventListener('change', apply);
      selCat?.addEventListener('change', apply);
      sortSel?.addEventListener('change', apply);

      // דיבאונס לחיפוש
      let t = null;
      inpSearch?.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(apply, 120);
      });

      clearBtn?.addEventListener('click', () => {
        if (selSide)   selSide.value = '';
        if (selPower)  selPower.value = '';
        if (selCat)    selCat.value = '';
        if (sortSel)   sortSel.value = 'name-asc';
        if (inpSearch) inpSearch.value = '';
        apply();
      });

      // ריצה ראשונית
      apply();
    })();
  </script>

  <!-- 🎨 סטיילינג — שילוב השראה מהעמוד הישן עם ה-A11y החדשים -->
  <style is:global>
    /* רקע ו"טון" כללי בהשראת האתר הישן */
    body {
      background: radial-gradient(circle at 50% -30%, #101820, #0b0b0b 60%);
    }

    .title-glow {
      font-family: "Bangers", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      letter-spacing: .5px;
      text-shadow: 0 0 10px rgba(255, 204, 0, .35);
    }

    .card-glass {
      background: rgba(255,255,255,.035);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: saturate(120%) blur(4px);
      border-radius: 1rem;
    }

    .info-block {
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.035);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
    }

    .text-white-70 { color: rgba(255,255,255,.7); }

    /* ===== Prime Children – Card & Title A11y upgrades ===== */
    .pc-card{
      background: linear-gradient(160deg, #12161d, #0f141b);
      border: 1px solid #2a3442;
      color: #e6ebf2;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
      border-radius: 16px;
    }
    .pc-card:hover,
    .pc-card:focus-visible{
      transform: translateY(-2px);
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
      border-color: #3c4b60;
      background: #151b24;
      outline: none;
    }

    .pc-thumb img{
      border-radius: 12px;
      object-fit: cover;
      width: 100%;
      height: auto;
      aspect-ratio: 1/1;
      display: block;
    }

    .pc-title{
      color: #f3f6fb;
      font-weight: 800;
      font-size: clamp(1.05rem, 1.8vw, 1.25rem);
      letter-spacing: .2px;
      line-height: 1.2;
      margin-top: .2rem;
      text-rendering: optimizeLegibility;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }
    .pc-card:hover .pc-title,
    .pc-card:focus-visible .pc-title{
      color: #ffffff;
    }

    .pc-card .badge{
      border-radius: 999px;
      font-weight: 700;
      opacity: .95;
    }
    .pc-card:hover .badge,
    .pc-card:focus-visible .badge{
      opacity: 1;
    }

    @media (prefers-color-scheme: light){
      .pc-card{
        background: #f8fafc;
        border-color: #d8e0ea;
        color: #0f172a;
      }
      .pc-card:hover,
      .pc-card:focus-visible{
        background: #ffffff;
        border-color: #c8d2df;
        box-shadow: 0 12px 28px rgba(2, 6, 23, .12);
      }
      .pc-title{
        color: #0b1324;
        text-shadow: none;
      }
      .info-block {
        background: rgba(10,15,25,.035);
        border-color: rgba(10,15,25,.12);
      }
      .card-glass {
        background: rgba(10,15,25,.05);
        border-color: rgba(10,15,25,.12);
      }
    }

    @media (prefers-reduced-motion: reduce){
      .pc-card{ transition: none; }
    }

    /* אזור מסננים — השראה primeChildren.css */
    #prime-lineages {
      background: rgba(20,20,20,.7);
      border: 1px solid #222;
      backdrop-filter: saturate(120%) blur(4px);
    }
    #prime-lineages label { font-weight: 600; }

    /* FAQ עם details */
    .faq-list .faq-item {
      border: 1px solid rgba(255,255,255,.12);
      border-radius: .8rem;
      padding: .75rem 1rem;
      background: rgba(255,255,255,.03);
      margin-bottom: .75rem;
    }
    .faq-list summary {
      cursor: pointer;
      font-weight: 600;
      color: #f8d459;
      list-style: none;
    }
    .faq-list summary::-webkit-details-marker { display: none; }
    .faq-list .faq-body { padding-top: .5rem; }

    /* עזר נגישות */
    .visually-hidden {
      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden; clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; border: 0; padding: 0; margin: -1px;
    }
    .bg-black-55 { background: rgba(0,0,0,.55); }
  </style>
</BaseLayout>
